<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG MetÄls | VadÄ«bas Panelis</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="admin_style.css">
</head>
<body>

    <div class="blob"></div>

    <a href="index.html" class="floating-back">
        <i class="fa-solid fa-arrow-left-long"></i>
        <span>SÄkumlapa</span>
    </a>

    <div id="loginSection" class="login-screen">
        <div class="login-glass">
            <h1 style="font-family: 'Oswald'; letter-spacing: 2px; margin-bottom: 35px;">MG PANELIS</h1>
            
            <div class="input-box">
                <input type="text" id="u" placeholder="LietotÄjvÄrds">
                <i class="fas fa-user-shield"></i>
            </div>
            
            <div class="input-box">
                <input type="password" id="p" placeholder="PiekÄ¼uves kods">
                <i class="fas fa-lock"></i>
            </div>
            
            <button onclick="login()" class="btn-modern">AutorizÄ“ties</button>
        </div>
    </div>

    <main id="dashboard" style="display: none;">
        <div class="nav-mini">
            <div class="status-tag">
                <span class="status-dot"></span>
                <span>SISTÄ’MA AKTÄªVA</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="stats" style="font-size: 0.8rem; color: var(--text-dim);"></div>
                <a href="#" onclick="logout()" class="logout-btn">IZIET</a>
            </div>
        </div>

        <div class="admin-controls">
            <div class="search-box">
                <input type="text" id="adminSearch" placeholder="MeklÄ“t pÄ“c vÄrda vai tÄlruÅ†a..." oninput="renderLeads()">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            
            <div class="filter-group">
                <button class="filter-btn active" onclick="setFilter('Visi', this)">Visi</button>
                <button class="filter-btn" onclick="setFilter('Jauns', this)">Jaunie</button>
                <button class="filter-btn" onclick="setFilter('ProcesÄ', this)">ProcesÄ</button>
                <button class="filter-btn" onclick="setFilter('Pabeigts', this)">Pabeigti</button>
            </div>
        </div>

        <div class="dashboard-grid" id="leadsGrid">
            </div>
    </main>

    <script>
        let allLeads = []; // GlobÄlais mainÄ«gais datiem
        let currentFilter = 'Visi';

        // 1. AutorizÄcija
        function login() {
            const user = document.getElementById('u').value;
            const pass = document.getElementById('p').value;
            if(user === "admin" && pass === "metal123") {
                localStorage.setItem('mg_core', 'active');
                showDash();
            } else {
                alert("Nepareizi piekÄ¼uves dati!");
            }
        }

        function logout() {
            localStorage.removeItem('mg_core');
            location.reload();
        }

        function showDash() {
            document.body.classList.add('logged-in');
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        }

        // 2. Datu ielÄde no JSON
        async function loadData() {
            try {
                const res = await fetch('pieteikumi.json?v=' + Date.now());
                allLeads = await res.json();
                renderLeads();
            } catch (err) { 
                console.error("KÄ¼Å«da ielÄdÄ“jot datus:", err); 
            }
        }

        // 3. Filtru pÄrslÄ“gÅ¡ana
        function setFilter(status, btn) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLeads();
        }

        // 4. GalvenÄ funkcija, kas izvada kartÄ«tes (ar filtru un meklÄ“tÄju)
        function renderLeads() {
            const grid = document.getElementById('leadsGrid');
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            grid.innerHTML = '';

            // FiltrÄ“jam datus pÄ“c statusa UN meklÄ“tÄja burtu virknes
            const filtered = allLeads.filter(item => {
                const matchesStatus = (currentFilter === 'Visi') || (item.statuss === currentFilter);
                const matchesSearch = (item.vards.toLowerCase().includes(searchTerm)) || 
                                     (item.kontakti.toLowerCase().includes(searchTerm));
                return matchesStatus && matchesSearch;
            });

            // ParÄdÄm statistiku
            document.getElementById('stats').innerText = `RÄdÄ«ti: ${filtered.length} no ${allLeads.length}`;

            // Ä¢enerÄ“jam HTML (reversÄ secÄ«bÄ - jaunÄkie augÅ¡Ä)
            [...filtered].reverse().forEach((item, i) => {
                // Atrodam oriÄ£inÄlo indeksu allLeads masÄ«vÄ priekÅ¡ update/delete
                const originalIdx = allLeads.findIndex(l => l === item);
                
                grid.innerHTML += `
                    <div class="glass-card">
                        <h3 class="client-name">${item.vards}</h3>
                        <span class="client-date">${item.datums || 'Nav norÄdÄ«ts'}</span>

                        <a href="tel:${item.kontakti}" class="contact-pill">
                            <i class="fas fa-phone"></i> ${item.kontakti}
                        </a>

                        <div class="message-content">${item.apraksts}</div>

                        <div class="card-actions">
                            <select class="modern-select" onchange="updateStatus(${originalIdx}, this.value)">
                                <option value="Jauns" ${item.statuss === 'Jauns' ? 'selected' : ''}>ğŸŸ¡ JAUNS</option>
                                <option value="ProcesÄ" ${item.statuss === 'ProcesÄ' ? 'selected' : ''}>ğŸ”µ PROCESÄ€</option>
                                <option value="Pabeigts" ${item.statuss === 'Pabeigts' ? 'selected' : ''}>ğŸŸ¢ PABEIGTS</option>
                            </select>
                            <div class="delete-icon" onclick="deleteEntry(${originalIdx})">
                                <i class="fas fa-trash-can"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // 5. DarbÄ«bas ar PHP
        async function updateStatus(id, stat) {
            await fetch('manage_pieteikumi.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'update', id, status: stat })
            });
            loadData();
        }

        async function deleteEntry(id) {
            if(!confirm("Vai tieÅ¡Äm vÄ“laties dzÄ“st?")) return;
            await fetch('manage_pieteikumi.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'delete', id })
            });
            loadData();
        }

        // PÄrbaude, vai sesija ir aktÄ«va
        if(localStorage.getItem('mg_core') === 'active') showDash();
    </script>
</body>
</html>